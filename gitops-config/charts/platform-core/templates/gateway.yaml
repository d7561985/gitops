{{- if .Values.gateway.enabled }}
{{- /*
Gateway resources for each enabled environment.
Creates:
  - Gateway resource with environment-specific domain
  - Additional listeners for domain mirrors
  - Certificate for HTTPS listener (via cert-manager, if enabled)

Each environment gets its own Gateway in its namespace with unique hostname.
CloudFlare Tunnel / external-dns routes traffic based on hostname.

Cilium creates a LoadBalancer service: cilium-gateway-{gateway-name}
Example: cilium-gateway-gateway in poc-dev namespace

Domain Mirrors:
  Define mirrors in environments.{env}.mirrors - each mirror automatically gets
  a Gateway listener and DNS record via external-dns.
*/ -}}

{{- range $envName, $env := .Values.environments }}
{{- if $env.enabled }}
{{- if $env.domain }}

{{- $gatewayNamespace := printf "%s-%s" $.Values.global.namespacePrefix $envName }}
{{- $listenerName := $.Values.gateway.listener.name | default "http-app" }}

{{- /* Collect all hostnames for external-dns target annotation */ -}}
{{- $allHostnames := list $env.domain }}
{{- if and $.Values.domainMirrors.enabled $env.mirrors }}
{{- range $mirror := $env.mirrors }}
{{- $allHostnames = append $allHostnames $mirror.domain }}
{{- end }}
{{- end }}

{{- /* Gateway resource */ -}}
---
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: gateway
  namespace: {{ $gatewayNamespace }}
  labels:
    app.kubernetes.io/name: platform-bootstrap
    app.kubernetes.io/component: gateway
    environment: {{ $envName }}
  {{- $hasAnnotations := false }}
  {{- if $.Values.gateway.certManager.enabled }}
  {{- $hasAnnotations = true }}
  {{- end }}
  {{- if $.Values.dns.enabled }}
  {{- $hasAnnotations = true }}
  {{- end }}
  {{- if $hasAnnotations }}
  annotations:
    {{- if $.Values.gateway.certManager.enabled }}
    cert-manager.io/cluster-issuer: {{ $.Values.gateway.certManager.clusterIssuer }}
    {{- end }}
    {{- if $.Values.dns.enabled }}
    external-dns.alpha.kubernetes.io/hostname: "{{ $env.domain }}{{ if $env.mirrors }},{{ range $i, $m := $env.mirrors }}{{ if $i }},{{ end }}{{ $m.domain }}{{ end }}{{ end }}{{ if and $.Values.previewEnvironments.enabled (eq $gatewayNamespace $.Values.previewEnvironments.gateway.namespace) }},*.{{ $.Values.previewEnvironments.baseDomain }}{{ end }}"
    {{- if and (eq $.Values.ingress.provider "cloudflare-tunnel") $.Values.ingress.cloudflare.tunnelId }}
    external-dns.alpha.kubernetes.io/target: "{{ $.Values.ingress.cloudflare.tunnelId }}.cfargotunnel.com"
    {{- else if and $.Values.ingress.haproxy $.Values.ingress.haproxy.loadBalancerIP }}
    external-dns.alpha.kubernetes.io/target: "{{ $.Values.ingress.haproxy.loadBalancerIP }}"
    {{- end }}
    {{- end }}
  {{- end }}
spec:
  gatewayClassName: {{ $.Values.gateway.gatewayClassName }}
  listeners:
    # Main domain listener
    - name: {{ $listenerName }}
      protocol: {{ $.Values.gateway.listener.protocol | default "HTTP" }}
      port: {{ $.Values.gateway.listener.port | default 80 }}
      hostname: {{ $env.domain | quote }}
      {{- if eq ($.Values.gateway.listener.protocol | default "HTTP") "HTTPS" }}
      tls:
        mode: Terminate
        certificateRefs:
          - name: {{ $listenerName }}-tls
            kind: Secret
      {{- end }}
      allowedRoutes:
        namespaces:
          from: Same
    {{- if and $.Values.domainMirrors.enabled $.Values.domainMirrors.addToGateway $env.mirrors }}
    {{- /* Mirror domain listeners */ -}}
    {{- range $idx, $mirror := $env.mirrors }}
    - name: http-mirror-{{ $idx }}
      protocol: {{ $.Values.gateway.listener.protocol | default "HTTP" }}
      port: {{ $.Values.gateway.listener.port | default 80 }}
      hostname: {{ $mirror.domain | quote }}
      allowedRoutes:
        namespaces:
          from: Same
    {{- end }}
    {{- end }}
    {{- /* Preview environments listener (for feature branch previews) */ -}}
    {{- /*
    Uses wildcard *.baseDomain which covers {jira-tag}.baseDomain
    HTTPRoute hostnames specify exact {jira-tag}.baseDomain
    */ -}}
    {{- if $.Values.previewEnvironments.enabled }}
    {{- if eq $gatewayNamespace $.Values.previewEnvironments.gateway.namespace }}
    - name: http-preview
      protocol: {{ $.Values.previewEnvironments.gateway.protocol | default "HTTP" }}
      port: {{ $.Values.previewEnvironments.gateway.port | default 80 }}
      hostname: "*.{{ $.Values.previewEnvironments.baseDomain }}"
      allowedRoutes:
        namespaces:
          from: Same
    {{- end }}
    {{- end }}

{{- /* Certificate for HTTPS listener (if cert-manager enabled) */ -}}
{{- if $.Values.gateway.certManager.enabled }}
{{- if eq ($.Values.gateway.listener.protocol | default "HTTP") "HTTPS" }}
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: {{ $listenerName }}-tls
  namespace: {{ $gatewayNamespace }}
  labels:
    app.kubernetes.io/name: platform-bootstrap
    environment: {{ $envName }}
spec:
  secretName: {{ $listenerName }}-tls
  issuerRef:
    name: {{ $.Values.gateway.certManager.clusterIssuer }}
    kind: ClusterIssuer
  dnsNames:
    - {{ $env.domain | quote }}
{{- end }}
{{- end }}

{{- else }}
{{- /* Warning if domain not set */ -}}
# WARNING: Environment {{ $envName }} has no domain configured!
# Gateway not created. Add 'domain' to environments.{{ $envName }} in values.yaml
{{- end }}
{{- end }}
{{- end }}
{{- end }}
