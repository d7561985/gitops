{{- if .Values.gateway.enabled }}
{{- /*
Gateway resources for each enabled environment.
Creates:
  - Gateway resource with environment-specific domain
  - Certificate for HTTPS listener (via cert-manager, if enabled)

Each environment gets its own Gateway in its namespace with unique hostname.
CloudFlare Tunnel routes traffic to the correct Gateway based on hostname.

Cilium creates a LoadBalancer service: cilium-gateway-{gateway-name}
Example: cilium-gateway-gateway in poc-dev namespace
*/ -}}

{{- range $envName, $env := .Values.environments }}
{{- if $env.enabled }}
{{- if $env.domain }}

{{- $gatewayNamespace := printf "%s-%s" $.Values.global.namespacePrefix $envName }}
{{- $listenerName := $.Values.gateway.listener.name | default "http-app" }}

{{- /* Gateway resource */ -}}
---
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: gateway
  namespace: {{ $gatewayNamespace }}
  labels:
    app.kubernetes.io/name: platform-bootstrap
    app.kubernetes.io/component: gateway
    environment: {{ $envName }}
  annotations:
    {{- if $.Values.gateway.certManager.enabled }}
    cert-manager.io/cluster-issuer: {{ $.Values.gateway.certManager.clusterIssuer }}
    {{- end }}
spec:
  gatewayClassName: {{ $.Values.gateway.gatewayClassName }}
  listeners:
    - name: {{ $listenerName }}
      protocol: {{ $.Values.gateway.listener.protocol | default "HTTP" }}
      port: {{ $.Values.gateway.listener.port | default 80 }}
      hostname: {{ $env.domain | quote }}
      {{- if eq ($.Values.gateway.listener.protocol | default "HTTP") "HTTPS" }}
      tls:
        mode: Terminate
        certificateRefs:
          - name: {{ $listenerName }}-tls
            kind: Secret
      {{- end }}
      allowedRoutes:
        namespaces:
          from: Same

{{- /* Certificate for HTTPS listener (if cert-manager enabled) */ -}}
{{- if $.Values.gateway.certManager.enabled }}
{{- if eq ($.Values.gateway.listener.protocol | default "HTTP") "HTTPS" }}
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: {{ $listenerName }}-tls
  namespace: {{ $gatewayNamespace }}
  labels:
    app.kubernetes.io/name: platform-bootstrap
    environment: {{ $envName }}
spec:
  secretName: {{ $listenerName }}-tls
  issuerRef:
    name: {{ $.Values.gateway.certManager.clusterIssuer }}
    kind: ClusterIssuer
  dnsNames:
    - {{ $env.domain | quote }}
{{- end }}
{{- end }}

{{- else }}
{{- /* Warning if domain not set */ -}}
# WARNING: Environment {{ $envName }} has no domain configured!
# Gateway not created. Add 'domain' to environments.{{ $envName }} in values.yaml
{{- end }}
{{- end }}
{{- end }}
{{- end }}
