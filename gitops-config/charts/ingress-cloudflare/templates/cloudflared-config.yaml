{{- /*
CloudFlare Tunnel ConfigMap for locally-managed mode.
Generates ingress rules from:
  - environments and their mirrors (application domains)
  - serviceGroups (infrastructure domains)

This ConfigMap is applied to the cloudflare namespace and used by cloudflared.
Requires stakater/Reloader or manual rollout restart when changed.

Only generated when:
  - ingress.provider: cloudflare-tunnel
  - ingress.cloudflare.enabled: true
*/ -}}
{{- if and (eq .Values.ingress.provider "cloudflare-tunnel") .Values.ingress.cloudflare.enabled }}
{{- if .Values.ingress.cloudflare.tunnelId }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: cloudflared-config
  namespace: {{ .Values.ingress.cloudflare.namespace | default "cloudflare" }}
  labels:
    app.kubernetes.io/name: ingress-cloudflare
    app.kubernetes.io/component: cloudflare-tunnel
  annotations:
    # Annotation for stakater/Reloader to restart cloudflared on config change
    reloader.stakater.com/auto: "true"
data:
  config.yaml: |
    # ==========================================================================
    # CloudFlare Tunnel Configuration (Locally-Managed)
    # ==========================================================================
    # Этот файл генерируется автоматически из ingress-cloudflare Helm chart.
    # Не редактируйте вручную - изменения будут перезаписаны!
    #
    # Добавление нового домена:
    # 1. Добавьте mirror в environments.{env}.mirrors в values.yaml
    # 2. ArgoCD синхронизирует изменения
    # 3. ConfigMap обновится автоматически
    # 4. cloudflared перезапустится (если установлен Reloader)
    # ==========================================================================

    # Tunnel ID
    tunnel: {{ .Values.ingress.cloudflare.tunnelId }}

    # Credentials file path (mounted from secret)
    credentials-file: /etc/cloudflared/credentials.json

    # Metrics endpoint
    metrics: 0.0.0.0:2000

    # Ingress rules
    ingress:
      {{- range $envName, $env := .Values.environments }}
      {{- if $env.enabled }}
      {{- if $env.domain }}
      {{- $gatewayService := printf "http://cilium-gateway-gateway.%s-%s.svc.cluster.local:80" $.Values.global.namespacePrefix $envName }}
      # === Environment: {{ $envName }} ===
      # Main domain
      - hostname: {{ $env.domain }}
        service: {{ $gatewayService }}
      {{- /* Mirror domains */ -}}
      {{- if and $.Values.domainMirrors.enabled $.Values.domainMirrors.addToTunnel $env.mirrors }}
      {{- range $idx, $mirror := $env.mirrors }}
      # Mirror {{ $idx }}: {{ $mirror.domain }}
      - hostname: {{ $mirror.domain }}
        service: {{ $gatewayService }}
      {{- end }}
      {{- end }}
      {{- end }}
      {{- end }}
      {{- end }}
      {{- /* Service Groups (infrastructure, databases, etc.) */ -}}
      {{- range $groupName, $group := .Values.serviceGroups }}
      {{- if $group.enabled }}
      {{- $clusterName := $group.clusterName | default "default" }}
      {{- $baseDomain := $group.baseDomain }}
      {{- $gatewayService := printf "http://cilium-gateway-gateway-%s.%s.svc.cluster.local:%d" $groupName $group.gatewayNamespace ($group.gateway.port | default 80 | int) }}
      # === Service Group: {{ $groupName }} ===
      {{- range $svcName, $svc := $group.services }}
      {{- if $svc.enabled }}
      {{- $hostname := printf "%s.%s.%s" $svc.subdomain $clusterName $baseDomain }}
      # {{ $svcName }}: {{ $hostname }}
      - hostname: {{ $hostname }}
        service: {{ $gatewayService }}
      {{- end }}
      {{- end }}
      {{- end }}
      {{- end }}
      {{- /* Preview Environments (wildcard for feature branches) */ -}}
      {{- if .Values.previewEnvironments.enabled }}
      {{- $previewGatewayService := printf "http://cilium-gateway-gateway.%s.svc.cluster.local:%d" .Values.previewEnvironments.gateway.namespace (.Values.previewEnvironments.gateway.port | default 80 | int) }}
      # === Preview Environments ===
      # Wildcard for feature branch previews
      - hostname: "*.{{ .Values.previewEnvironments.baseDomain }}"
        service: {{ $previewGatewayService }}
      {{- end }}
      # Catch-all rule (required at the end)
      - service: http_status:404
{{- end }}
{{- end }}
