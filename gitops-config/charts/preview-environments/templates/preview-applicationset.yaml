{{- /*
Preview Environments ApplicationSet

Generates ArgoCD Applications for Merge Requests with JIRA-tagged branches.
Uses Pull Request Generator to watch GitLab MRs.

Shared Namespace Mode:
- Previews deploy to existing namespace (e.g., poc-dev)
- No namespace sprawl, secrets already exist
- Resources distinguished by appName suffix (e.g., sentry-frontend-jira-0001)

Branch naming convention: PROJ-123-description
- branchMatch filters: only branches starting with JIRA tag
- regexFind extracts: JIRA tag for short URL (proj-123.preview.domain.com)

Flow:
  Branch PROJ-123-feature → MR opened → Application created → Preview deployed
  MR closed/merged → Application deleted → Preview resources cleaned up

Reference: https://argo-cd.readthedocs.io/en/latest/operator-manual/applicationset/Generators-Pull-Request/
*/ -}}

{{- if .Values.previewEnvironments.enabled }}
{{- range $serviceName, $service := .Values.previewEnvironments.services }}
{{- if $service.enabled }}
{{- if $service.projectId }}
---
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: preview-{{ $serviceName }}
  namespace: argocd
  labels:
    app.kubernetes.io/name: platform-bootstrap
    app.kubernetes.io/component: preview-environments
spec:
  # Go template mode for proper variable substitution
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]

  generators:
    - pullRequest:
        gitlab:
          # GitLab Project ID (numeric)
          project: {{ $service.projectId | quote }}
          # GitLab API URL
          api: {{ $.Values.previewEnvironments.gitlab.api }}
          # Token for API access
          tokenRef:
            secretName: {{ $.Values.previewEnvironments.gitlab.tokenRef.secretName }}
            key: {{ $.Values.previewEnvironments.gitlab.tokenRef.key }}
          # Only opened MRs
          pullRequestState: opened
        # How often to check for new MRs
        requeueAfterSeconds: {{ $.Values.previewEnvironments.gitlab.requeueAfterSeconds }}
        {{- if $service.branchMatch }}
        # Filter by branch naming convention (JIRA tag)
        # Pattern: PROJ-123-description
        filters:
          - branchMatch: {{ $service.branchMatch | quote }}
        {{- end }}

  template:
    metadata:
      # Name: preview-frontend-proj-123 (only JIRA tag, not full branch)
      name: 'preview-{{ $serviceName }}-{{`{{ regexFind "^[A-Za-z]+-[0-9]+" .branch | lower }}`}}'
      namespace: argocd
      labels:
        app.kubernetes.io/name: preview-{{ $serviceName }}
        app.kubernetes.io/component: preview
        preview/service: {{ $serviceName }}
        preview/jira-tag: '{{`{{ regexFind "^[A-Za-z]+-[0-9]+" .branch | lower }}`}}'
        preview/mr-number: '{{`{{.number}}`}}'
      annotations:
        # For debugging
        preview/branch: '{{`{{.branch}}`}}'
        preview/author: '{{`{{.author}}`}}'
        preview/head-sha: '{{`{{.head_short_sha}}`}}'
      finalizers:
        - resources-finalizer.argocd.argoproj.io
    spec:
      project: {{ $.Values.applicationSet.project }}

      sources:
        # k8app Helm chart
        - repoURL: {{ $.Values.global.k8app.repoURL }}
          chart: {{ $.Values.global.k8app.chart }}
          targetRevision: {{ $.Values.global.k8app.version | quote }}
          helm:
            # Base config from service repo
            valueFiles:
              - $values/{{ $service.cicdPath }}/default.yaml
            # Preview-specific overrides
            values: |
              # Override app name to include JIRA tag (e.g., sentry-frontend-jira-0001)
              # This ensures unique resource names in shared namespace
              appName: "{{ $service.appNameBase | default $serviceName }}-{{`{{ regexFind "^[A-Za-z]+-[0-9]+" .branch | lower }}`}}"

              # Use branch name as image tag
              # CI tags images with sanitized branch name (lowercase, special chars to dashes)
              # This avoids issues with [skip ci] commits changing HEAD after image build
              image:
                tag: "{{`{{.branch | replace "/" "-" | lower}}`}}"

              # Preview-specific hostname: {jira-tag}.domain.com
              # Format covered by CloudFlare Universal SSL wildcard *.baseDomain
              httpRoute:
                enabled: true
                hostnames:
                  - "{{`{{ regexFind "^[A-Za-z]+-[0-9]+" .branch | lower }}`}}.{{ $.Values.previewEnvironments.baseDomain }}"
                parentRefs:
                  - name: gateway
                    namespace: {{ $.Values.previewEnvironments.gateway.namespace }}
                    sectionName: http-preview
                rules:
                  # /api → shared backend (api-gateway-sv in same namespace)
                  # More specific path takes precedence over catch-all
                  - matches:
                      - path:
                          type: PathPrefix
                          value: /api
                    backendRefs:
                      - name: api-gateway-sv
                        port: 8080
                  # / → preview frontend (unique per JIRA tag)
                  - matches:
                      - path:
                          type: PathPrefix
                          value: /
                    backendRefs:
                      - name: "{{ $service.appNameBase | default $serviceName }}-{{`{{ regexFind "^[A-Za-z]+-[0-9]+" .branch | lower }}`}}-sv"
                        port: 4200

              # Use same namespace backend (no cross-namespace needed)
              configmap:
                API_URL: "http://api-gateway-sv:8080"

              # Disable Vault for preview (use existing secrets in namespace)
              vault:
                enabled: false

        # Service repository (for default.yaml)
        - repoURL: {{ $service.repoURL }}
          targetRevision: '{{`{{.branch}}`}}'
          ref: values

      destination:
        server: https://kubernetes.default.svc
        # Deploy to existing namespace (secrets already there, no namespace sprawl)
        namespace: '{{ $service.namespace }}'

      syncPolicy:
        syncOptions:
          - PruneLast=true
        automated:
          prune: true
          selfHeal: true

      # Cleanup when Application is deleted (MR closed)
      # finalizers ensure namespace cleanup
{{- end }}
{{- end }}
{{- end }}
{{- end }}
