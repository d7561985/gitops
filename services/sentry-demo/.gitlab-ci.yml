# GitLab CI/CD for sentry-demo monorepo
# Pull-based GitOps with ArgoCD + Semantic Versioning
#
# Flow:
#   main branch changes  → build changed services → dev (auto)
#   v*-rc.*/beta/alpha tags → build ALL services → staging (auto)
#   v*.*.* release tags → build ALL services → staging (auto) → prod (manual)
#
# Required CI/CD Variables:
#   CI_PUSH_TOKEN     - Group Access Token with write_repository scope
#   ARGOCD_SERVER     - ArgoCD server URL (e.g., argocd.example.com)
#   ARGOCD_AUTH_TOKEN - ArgoCD API token

stages:
  - build
  - update-manifests
  - release

variables:
  DOCKER_TLS_CERTDIR: "/certs"
  RELEASE_TIMEOUT: "300"

# =============================================================================
# Release Template - Waits for ArgoCD deployment
# =============================================================================
.release-template:
  stage: release
  image: alpine:3.19
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      echo "Waiting for ${ARGOCD_APP_NAME} to sync and become healthy..."
      echo "ArgoCD Server: https://${ARGOCD_SERVER}"
      echo "Timeout: ${RELEASE_TIMEOUT}s"

      ARGOCD_API="https://${ARGOCD_SERVER}/api/v1/applications/${ARGOCD_APP_NAME}"
      AUTH_HEADER="Authorization: Bearer ${ARGOCD_AUTH_TOKEN}"

      curl -sf "${ARGOCD_API}?refresh=normal" -H "${AUTH_HEADER}" > /dev/null || true

      start_time=$(date +%s)
      while true; do
        response=$(curl -sf "${ARGOCD_API}" -H "${AUTH_HEADER}" 2>/dev/null)
        if [ $? -ne 0 ]; then
          echo "ERROR: Failed to get application status"
          exit 1
        fi

        sync_status=$(echo "$response" | jq -r '.status.sync.status // "Unknown"')
        health_status=$(echo "$response" | jq -r '.status.health.status // "Unknown"')

        echo "Status: sync=${sync_status}, health=${health_status}"

        if [ "$sync_status" = "Synced" ] && [ "$health_status" = "Healthy" ]; then
          echo ""
          echo "=== RELEASE SUCCESSFUL ==="
          echo "Application: ${ARGOCD_APP_NAME}"
          exit 0
        fi

        elapsed=$(($(date +%s) - start_time))
        if [ $elapsed -ge ${RELEASE_TIMEOUT} ]; then
          echo "ERROR: Timeout after ${RELEASE_TIMEOUT}s"
          exit 1
        fi

        sleep 5
      done

# =============================================================================
# Build Template (base)
# =============================================================================
.build-template:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_BUILDKIT: "1"
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - apk add --no-cache git yq
    - git config --global user.email "ci@gitlab.com"
    - git config --global user.name "GitLab CI"
    - git remote set-url origin "https://oauth2:${CI_PUSH_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
    - git fetch origin ${CI_DEFAULT_BRANCH}
    - git checkout ${CI_DEFAULT_BRANCH}
    - git pull origin ${CI_DEFAULT_BRANCH}

# =============================================================================
# Build Template with Proto Packages (for services with private deps)
# =============================================================================
.build-with-proto-template:
  extends: .build-template
  script:
    - |
      echo "Building $SERVICE_NAME..."

      # Determine image tag
      if [ -n "$CI_COMMIT_TAG" ]; then
        IMAGE_TAG="${CI_COMMIT_TAG}"
        echo "Building release image with tag: ${IMAGE_TAG}"
      else
        IMAGE_TAG="${CI_COMMIT_SHORT_SHA}"
        echo "Building dev image with SHA: ${IMAGE_TAG}"
      fi

      # Create token file for BuildKit secret
      echo "$CI_PUSH_TOKEN" > /tmp/gitlab_token

      docker build \
        --secret id=gitlab_token,src=/tmp/gitlab_token \
        ${DOCKER_BUILD_ARGS:-} \
        -t $CI_REGISTRY_IMAGE/$SERVICE_NAME:$IMAGE_TAG \
        $SERVICE_PATH

      rm -f /tmp/gitlab_token

      docker push $CI_REGISTRY_IMAGE/$SERVICE_NAME:$IMAGE_TAG

      # Tag as latest for main branch
      if [ "$CI_COMMIT_BRANCH" == "$CI_DEFAULT_BRANCH" ]; then
        docker tag $CI_REGISTRY_IMAGE/$SERVICE_NAME:$IMAGE_TAG $CI_REGISTRY_IMAGE/$SERVICE_NAME:latest
        docker push $CI_REGISTRY_IMAGE/$SERVICE_NAME:latest
      fi

# =============================================================================
# Update Manifest Templates
# =============================================================================
.update-dev-template:
  stage: update-manifests
  image: alpine:3.19
  before_script:
    - apk add --no-cache git yq
    - git config --global user.email "ci@gitlab.com"
    - git config --global user.name "GitLab CI"
    - git remote set-url origin "https://oauth2:${CI_PUSH_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
    - git fetch origin ${CI_DEFAULT_BRANCH}
    - git checkout ${CI_DEFAULT_BRANCH}
    - git pull origin ${CI_DEFAULT_BRANCH}
  script:
    - |
      echo "Updating dev environment for $SERVICE_NAME to ${CI_COMMIT_SHORT_SHA}"
      yq -i '.image.tag = "'${CI_COMMIT_SHORT_SHA}'"' $SERVICE_PATH/.cicd/dev.yaml
      yq -i '.image.repository = "'${CI_REGISTRY_IMAGE}/${SERVICE_NAME}'"' $SERVICE_PATH/.cicd/dev.yaml

      git add $SERVICE_PATH/.cicd/dev.yaml
      git commit -m "ci($SERVICE_NAME): update dev to ${CI_COMMIT_SHORT_SHA} [skip ci]" || true
      git push origin ${CI_DEFAULT_BRANCH} || true

.update-staging-template:
  stage: update-manifests
  image: alpine:3.19
  before_script:
    - apk add --no-cache git yq
    - git config --global user.email "ci@gitlab.com"
    - git config --global user.name "GitLab CI"
    - git remote set-url origin "https://oauth2:${CI_PUSH_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
    - git fetch origin ${CI_DEFAULT_BRANCH}
    - git checkout ${CI_DEFAULT_BRANCH}
    - git pull origin ${CI_DEFAULT_BRANCH}
  script:
    - |
      echo "Updating staging environment for $SERVICE_NAME to ${CI_COMMIT_TAG}"
      yq -i '.image.tag = "'${CI_COMMIT_TAG}'"' $SERVICE_PATH/.cicd/staging.yaml
      yq -i '.image.repository = "'${CI_REGISTRY_IMAGE}/${SERVICE_NAME}'"' $SERVICE_PATH/.cicd/staging.yaml

      git add $SERVICE_PATH/.cicd/staging.yaml
      git commit -m "ci($SERVICE_NAME): update staging to ${CI_COMMIT_TAG} [skip ci]" || true
      git push origin ${CI_DEFAULT_BRANCH} || true

# =============================================================================
# Frontend (Angular)
# =============================================================================
build:frontend:
  extends: .build-with-proto-template
  variables:
    SERVICE_NAME: frontend
    SERVICE_PATH: frontend
    DOCKER_BUILD_ARGS: "--build-arg APP_VERSION=${CI_COMMIT_TAG:-$CI_COMMIT_SHORT_SHA}"
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+.*$/
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - frontend/**/*

update:frontend:dev:
  extends: .update-dev-template
  variables:
    SERVICE_NAME: frontend
    SERVICE_PATH: frontend
  needs:
    - job: build:frontend
      optional: true
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - frontend/**/*

update:frontend:staging:
  extends: .update-staging-template
  variables:
    SERVICE_NAME: frontend
    SERVICE_PATH: frontend
  needs:
    - job: build:frontend
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+.*$/

release:frontend:dev:
  extends: .release-template
  variables:
    ARGOCD_APP_NAME: sentry-frontend-dev
  needs:
    - job: update:frontend:dev
      optional: true
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - frontend/**/*

release:frontend:staging:
  extends: .release-template
  variables:
    ARGOCD_APP_NAME: sentry-frontend-staging
  needs:
    - job: update:frontend:staging
      optional: true
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+.*$/

# =============================================================================
# Game Engine (Python/Tornado)
# =============================================================================
build:game-engine:
  extends: .build-with-proto-template
  variables:
    SERVICE_NAME: game-engine
    SERVICE_PATH: game-engine
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+.*$/
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - game-engine/**/*

update:game-engine:dev:
  extends: .update-dev-template
  variables:
    SERVICE_NAME: game-engine
    SERVICE_PATH: game-engine
  needs:
    - job: build:game-engine
      optional: true
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - game-engine/**/*

update:game-engine:staging:
  extends: .update-staging-template
  variables:
    SERVICE_NAME: game-engine
    SERVICE_PATH: game-engine
  needs:
    - job: build:game-engine
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+.*$/

release:game-engine:dev:
  extends: .release-template
  variables:
    ARGOCD_APP_NAME: sentry-game-engine-dev
  needs:
    - job: update:game-engine:dev
      optional: true
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - game-engine/**/*

release:game-engine:staging:
  extends: .release-template
  variables:
    ARGOCD_APP_NAME: sentry-game-engine-staging
  needs:
    - job: update:game-engine:staging
      optional: true
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+.*$/

# =============================================================================
# Payment Service (Node.js/Express)
# =============================================================================
build:payment-service:
  extends: .build-with-proto-template
  variables:
    SERVICE_NAME: payment-service
    SERVICE_PATH: payment-service
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+.*$/
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - payment-service/**/*

update:payment-service:dev:
  extends: .update-dev-template
  variables:
    SERVICE_NAME: payment-service
    SERVICE_PATH: payment-service
  needs:
    - job: build:payment-service
      optional: true
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - payment-service/**/*

update:payment-service:staging:
  extends: .update-staging-template
  variables:
    SERVICE_NAME: payment-service
    SERVICE_PATH: payment-service
  needs:
    - job: build:payment-service
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+.*$/

release:payment-service:dev:
  extends: .release-template
  variables:
    ARGOCD_APP_NAME: sentry-payment-dev
  needs:
    - job: update:payment-service:dev
      optional: true
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - payment-service/**/*

release:payment-service:staging:
  extends: .release-template
  variables:
    ARGOCD_APP_NAME: sentry-payment-staging
  needs:
    - job: update:payment-service:staging
      optional: true
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+.*$/

# =============================================================================
# Wager Service (PHP/Symfony)
# =============================================================================
build:wager-service:
  extends: .build-with-proto-template
  variables:
    SERVICE_NAME: wager-service
    SERVICE_PATH: wager-service
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+.*$/
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - wager-service/**/*

update:wager-service:dev:
  extends: .update-dev-template
  variables:
    SERVICE_NAME: wager-service
    SERVICE_PATH: wager-service
  needs:
    - job: build:wager-service
      optional: true
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - wager-service/**/*

update:wager-service:staging:
  extends: .update-staging-template
  variables:
    SERVICE_NAME: wager-service
    SERVICE_PATH: wager-service
  needs:
    - job: build:wager-service
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+.*$/

release:wager-service:dev:
  extends: .release-template
  variables:
    ARGOCD_APP_NAME: sentry-wager-dev
  needs:
    - job: update:wager-service:dev
      optional: true
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - wager-service/**/*

release:wager-service:staging:
  extends: .release-template
  variables:
    ARGOCD_APP_NAME: sentry-wager-staging
  needs:
    - job: update:wager-service:staging
      optional: true
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+.*$/
