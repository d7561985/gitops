# GitLab CI/CD Pipeline for Push-based GitOps
# Source: https://docs.gitlab.com/user/clusters/agent/ci_cd_workflow/
#
# This template should be copied to each service repository
# and customized with the appropriate service name and values

variables:
  # Service configuration (customize per service)
  SERVICE_NAME: "api-gateway"
  HELM_CHART: "k8app/app"
  HELM_CHART_VERSION: "latest"

  # GitLab Agent context
  # Format: <path/to/agent/project>:<agent-name>
  KUBE_CONTEXT: "your-group/gitops-poc:minikube-agent"

  # Namespaces per environment
  DEV_NAMESPACE: "${SERVICE_NAME}-dev"
  STAGING_NAMESPACE: "${SERVICE_NAME}-staging"
  PROD_NAMESPACE: "${SERVICE_NAME}-prod"

# Default image with kubectl and helm
default:
  image: dtzar/helm-kubectl:3.13
  before_script:
    - helm repo add k8app https://d7561985.github.io/k8app
    - helm repo update

stages:
  - validate
  - deploy-dev
  - deploy-staging
  - deploy-prod

# ============================================
# Validation Stage
# ============================================

validate:helm:
  stage: validate
  script:
    - echo "Validating Helm values..."
    - helm template ${SERVICE_NAME} ${HELM_CHART} \
        -f helm/default.yaml \
        -f helm/dev.yaml \
        --debug > /dev/null
    - echo "Helm template validation passed"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# ============================================
# Dev Environment
# ============================================

deploy:dev:
  stage: deploy-dev
  environment:
    name: dev
    kubernetes:
      namespace: ${DEV_NAMESPACE}
  script:
    - kubectl config use-context ${KUBE_CONTEXT}

    # Create namespace if not exists
    - kubectl create namespace ${DEV_NAMESPACE} --dry-run=client -o yaml | kubectl apply -f -

    # Deploy with Helm
    - |
      helm upgrade --install ${SERVICE_NAME} ${HELM_CHART} \
        --namespace ${DEV_NAMESPACE} \
        --wait \
        --timeout 5m \
        -f helm/default.yaml \
        -f helm/dev.yaml \
        --set version=${CI_COMMIT_SHORT_SHA}

    # Verify deployment
    - kubectl rollout status deployment/${SERVICE_NAME} -n ${DEV_NAMESPACE} --timeout=3m

    - echo "Deployment to dev completed successfully"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# ============================================
# Staging Environment
# ============================================

deploy:staging:
  stage: deploy-staging
  environment:
    name: staging
    kubernetes:
      namespace: ${STAGING_NAMESPACE}
  script:
    - kubectl config use-context ${KUBE_CONTEXT}
    - kubectl create namespace ${STAGING_NAMESPACE} --dry-run=client -o yaml | kubectl apply -f -

    - |
      helm upgrade --install ${SERVICE_NAME} ${HELM_CHART} \
        --namespace ${STAGING_NAMESPACE} \
        --wait \
        --timeout 5m \
        -f helm/default.yaml \
        -f helm/staging.yaml \
        --set version=${CI_COMMIT_SHORT_SHA}

    - kubectl rollout status deployment/${SERVICE_NAME} -n ${STAGING_NAMESPACE} --timeout=3m
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
  needs:
    - deploy:dev

# ============================================
# Production Environment
# ============================================

deploy:prod:
  stage: deploy-prod
  environment:
    name: production
    kubernetes:
      namespace: ${PROD_NAMESPACE}
  script:
    - kubectl config use-context ${KUBE_CONTEXT}
    - kubectl create namespace ${PROD_NAMESPACE} --dry-run=client -o yaml | kubectl apply -f -

    - |
      helm upgrade --install ${SERVICE_NAME} ${HELM_CHART} \
        --namespace ${PROD_NAMESPACE} \
        --wait \
        --timeout 10m \
        -f helm/default.yaml \
        -f helm/prod.yaml \
        --set version=${CI_COMMIT_SHORT_SHA}

    - kubectl rollout status deployment/${SERVICE_NAME} -n ${PROD_NAMESPACE} --timeout=5m
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
  needs:
    - deploy:staging
  # Production requires manual approval
  allow_failure: false
