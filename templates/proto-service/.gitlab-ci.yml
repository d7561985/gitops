# GitLab CI/CD Pipeline for Proto Code Generation
#
# This pipeline:
# 1. Lints proto files with Buf
# 2. Checks for breaking changes against main branch
# 3. Generates code for all languages (Go, Node.js, PHP, Python, Angular)
# 4. Publishes each language to separate repository under gen/{service-name}/{lang}
#
# Structure:
#   api/proto/{service}     → source proto files
#   api/gen/{service}/      → sub-group (auto-created)
#   api/gen/{service}/go    → Go repository
#   api/gen/{service}/nodejs → Node.js repository
#   api/gen/{service}/php   → PHP repository
#   api/gen/{service}/python → Python repository
#   api/gen/{service}/angular → Angular/gRPC-Web repository
#
# Versioning:
# - dev branch: v0.0.0-{short-sha}
# - main + tags: v{major}.{minor}.{patch}
#
# Required CI/CD Variables (set at api group level):
#   CI_PUSH_TOKEN   - Group Access Token with write_repository, read_api, create_group scope
#   GEN_GROUP_ID    - GitLab Group ID for api/gen (for creating sub-groups)

variables:
  SERVICE_NAME: ${CI_PROJECT_NAME}
  GEN_GROUP_PATH: "gitops-poc-dzha/api/gen"
  BUF_VERSION: "1.47.2"
  DEFAULT_BRANCH: "main"

stages:
  - lint
  - breaking
  - generate
  - publish

# ============================================
# Lint Stage
# ============================================
lint:
  stage: lint
  image: alpine:3.19
  before_script:
    - apk add --no-cache curl
    - curl -sSL "https://github.com/bufbuild/buf/releases/download/v${BUF_VERSION}/buf-Linux-x86_64" -o /usr/local/bin/buf
    - chmod +x /usr/local/bin/buf
  script:
    - echo "Running Buf lint on ${SERVICE_NAME}..."
    - buf lint
    - echo "Checking formatting..."
    - buf format --diff --exit-code || echo "Warning - formatting issues found"
    - echo "Lint passed!"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "dev"
    - if: $CI_COMMIT_BRANCH == $DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

# ============================================
# Breaking Change Detection
# ============================================
breaking:
  stage: breaking
  image: alpine:3.19
  before_script:
    - apk add --no-cache curl git
    - curl -sSL "https://github.com/bufbuild/buf/releases/download/v${BUF_VERSION}/buf-Linux-x86_64" -o /usr/local/bin/buf
    - chmod +x /usr/local/bin/buf
  script:
    - echo "Checking for breaking changes against ${DEFAULT_BRANCH}..."
    - |
      if git rev-parse --verify origin/${DEFAULT_BRANCH} > /dev/null 2>&1; then
        buf breaking --against ".git#branch=${DEFAULT_BRANCH}"
        echo "No breaking changes detected!"
      else
        echo "No ${DEFAULT_BRANCH} branch found, skipping breaking change check"
      fi
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "dev"
  allow_failure: false

# ============================================
# Generate Stage
# ============================================
generate:
  stage: generate
  image: alpine:3.19
  before_script:
    - apk add --no-cache curl git
    - curl -sSL "https://github.com/bufbuild/buf/releases/download/v${BUF_VERSION}/buf-Linux-x86_64" -o /usr/local/bin/buf
    - chmod +x /usr/local/bin/buf
  script:
    - echo "Generating code for ${SERVICE_NAME}..."
    - rm -rf gen/
    - buf dep update
    - buf generate
    - echo "Generated code structure:"
    - find gen/ -type f | head -50 || echo "No files generated"
  artifacts:
    paths:
      - gen/
    expire_in: 1 hour
  rules:
    - if: $CI_COMMIT_BRANCH == "dev"
    - if: $CI_COMMIT_BRANCH == $DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

# ============================================
# Publish Stage
# ============================================
publish:
  stage: publish
  image: alpine:3.19
  needs:
    - job: generate
      artifacts: true
  before_script:
    - apk add --no-cache git curl jq
    - git config --global user.email "ci@gitlab.com"
    - git config --global user.name "GitLab CI Proto Generator"
    - git config --global init.defaultBranch main
  script:
    - |
      # ==========================================
      # Determine version
      # ==========================================
      if [ -n "${CI_COMMIT_TAG}" ]; then
        VERSION="${CI_COMMIT_TAG}"
        IS_RELEASE="true"
        echo "Release version: ${VERSION}"
      elif [ "${CI_COMMIT_BRANCH}" = "${DEFAULT_BRANCH}" ]; then
        VERSION="v0.0.0-${CI_COMMIT_SHORT_SHA}"
        IS_RELEASE="false"
        echo "Main branch snapshot: ${VERSION}"
      else
        VERSION="v0.0.0-${CI_COMMIT_SHORT_SHA}"
        IS_RELEASE="false"
        echo "Dev version: ${VERSION}"
      fi

      # ==========================================
      # Ensure service sub-group exists under api/gen
      # ==========================================
      echo "Checking if sub-group exists: ${GEN_GROUP_PATH}/${SERVICE_NAME}..."
      SERVICE_GROUP_ID=$(curl -s --header "PRIVATE-TOKEN: ${CI_PUSH_TOKEN}" \
        "https://${CI_SERVER_HOST}/api/v4/groups/${GEN_GROUP_PATH//\//%2F}%2F${SERVICE_NAME}" \
        | jq -r '.id // empty')

      if [ -z "${SERVICE_GROUP_ID}" ]; then
        echo "Creating sub-group: ${GEN_GROUP_PATH}/${SERVICE_NAME}"
        CREATE_RESPONSE=$(curl -s --header "PRIVATE-TOKEN: ${CI_PUSH_TOKEN}" \
          -X POST "https://${CI_SERVER_HOST}/api/v4/groups" \
          -d "name=${SERVICE_NAME}" \
          -d "path=${SERVICE_NAME}" \
          -d "parent_id=${GEN_GROUP_ID}" \
          -d "visibility=private" \
          -d "description=Generated gRPC/proto code for ${SERVICE_NAME}")
        echo "API Response: ${CREATE_RESPONSE}"
        SERVICE_GROUP_ID=$(echo "${CREATE_RESPONSE}" | jq -r '.id // empty')
        if [ -z "${SERVICE_GROUP_ID}" ] || [ "${SERVICE_GROUP_ID}" = "null" ]; then
          echo "ERROR: Failed to create sub-group. Check CI_PUSH_TOKEN has 'api' scope and Owner role."
          echo "Trying to get existing group ID..."
          SERVICE_GROUP_ID=$(curl -s --header "PRIVATE-TOKEN: ${CI_PUSH_TOKEN}" \
            "https://${CI_SERVER_HOST}/api/v4/groups?search=${SERVICE_NAME}" \
            | jq -r ".[] | select(.full_path==\"${GEN_GROUP_PATH}/${SERVICE_NAME}\") | .id // empty")
        fi
        echo "Sub-group ID: ${SERVICE_GROUP_ID}"
        sleep 2
      else
        echo "Sub-group already exists (ID: ${SERVICE_GROUP_ID})"
      fi

      if [ -z "${SERVICE_GROUP_ID}" ] || [ "${SERVICE_GROUP_ID}" = "null" ]; then
        echo "ERROR: Cannot determine SERVICE_GROUP_ID. Aborting."
        exit 1
      fi

      # ==========================================
      # Function: Generate package file
      # ==========================================
      generate_package_file() {
        local LANG=$1
        local REPO_PATH=$2
        local SERVICE_PASCAL=$(echo "${SERVICE_NAME}" | sed -r 's/(^|-)([a-z])/\U\2/g')

        case "${LANG}" in
          go)
            cat > go.mod << PKGEOF
      module gitlab.com/${REPO_PATH}

      go 1.22

      require (
      	google.golang.org/grpc v1.68.1
      	google.golang.org/protobuf v1.35.2
      )

      require (
      	golang.org/x/net v0.32.0 // indirect
      	golang.org/x/sys v0.28.0 // indirect
      	golang.org/x/text v0.21.0 // indirect
      	google.golang.org/genproto/googleapis/rpc v0.0.0-20241209162323-e6fa225c2576 // indirect
      )
      PKGEOF
            echo "Created go.mod"
            ;;

          nodejs)
            cat > package.json << PKGEOF
      {
        "name": "@gitops-poc-dzha/${SERVICE_NAME}",
        "version": "${VERSION#v}",
        "description": "gRPC client/server stubs for ${SERVICE_NAME}",
        "main": "index.js",
        "types": "index.d.ts",
        "repository": {
          "type": "git",
          "url": "https://${CI_SERVER_HOST}/${REPO_PATH}.git"
        },
        "dependencies": {
          "@grpc/grpc-js": "^1.10.0",
          "@protobuf-ts/runtime": "^2.9.4",
          "@protobuf-ts/runtime-rpc": "^2.9.4"
        },
        "peerDependencies": {
          "typescript": ">=4.5.0"
        }
      }
      PKGEOF
            echo "Created package.json"
            ;;

          php)
            cat > composer.json << PKGEOF
      {
        "name": "gitops-poc-dzha/${SERVICE_NAME}",
        "description": "gRPC client/server stubs for ${SERVICE_NAME}",
        "version": "${VERSION#v}",
        "type": "library",
        "license": "proprietary",
        "require": {
          "php": ">=8.1",
          "grpc/grpc": "^1.57",
          "google/protobuf": "^4.25"
        },
        "autoload": {
          "psr-4": {
            "GitopsPocDzha\\\\${SERVICE_PASCAL}\\\\": ""
          }
        }
      }
      PKGEOF
            echo "Created composer.json"
            ;;

          python)
            cat > pyproject.toml << PKGEOF
      [build-system]
      requires = ["setuptools>=61.0", "wheel"]
      build-backend = "setuptools.build_meta"

      [project]
      name = "gitops-poc-dzha-${SERVICE_NAME}"
      version = "${VERSION#v}"
      description = "gRPC client/server stubs for ${SERVICE_NAME}"
      requires-python = ">=3.9"
      dependencies = [
          "grpcio>=1.62.0",
          "protobuf>=4.25.0",
      ]

      [project.optional-dependencies]
      dev = [
          "grpcio-tools>=1.62.0",
      ]

      [tool.setuptools.packages.find]
      where = ["."]
      PKGEOF
            find . -type d -exec touch {}/__init__.py \;
            echo "Created pyproject.toml"
            ;;

          angular)
            cat > package.json << PKGEOF
      {
        "name": "@gitops-poc-dzha/${SERVICE_NAME}-web",
        "version": "${VERSION#v}",
        "description": "gRPC-Web client stubs for ${SERVICE_NAME} (browser)",
        "main": "index.js",
        "types": "index.d.ts",
        "repository": {
          "type": "git",
          "url": "https://${CI_SERVER_HOST}/${REPO_PATH}.git"
        },
        "dependencies": {
          "google-protobuf": "^3.21.0",
          "grpc-web": "^1.5.0"
        },
        "peerDependencies": {
          "@angular/core": ">=16.0.0",
          "rxjs": ">=7.0.0"
        }
      }
      PKGEOF
            echo "Created package.json"
            ;;
        esac
      }

      # ==========================================
      # Function: Publish language repository
      # ==========================================
      publish_lang_repo() {
        local LANG=$1
        local LANG_DIR="${CI_PROJECT_DIR}/gen/${LANG}"

        if [ ! -d "${LANG_DIR}" ]; then
          echo "Skipping ${LANG} - no generated code"
          return 0
        fi

        echo ""
        echo "=========================================="
        echo "Publishing ${LANG}..."
        echo "=========================================="

        local REPO_PATH="${GEN_GROUP_PATH}/${SERVICE_NAME}/${LANG}"
        local REPO_URL="https://oauth2:${CI_PUSH_TOKEN}@${CI_SERVER_HOST}/${REPO_PATH}.git"

        # Check if repo exists, create if not
        local REPO_ID=$(curl -s --header "PRIVATE-TOKEN: ${CI_PUSH_TOKEN}" \
          "https://${CI_SERVER_HOST}/api/v4/projects/${REPO_PATH//\//%2F}" \
          | jq -r '.id // empty')

        if [ -z "${REPO_ID}" ]; then
          echo "Creating repository: ${REPO_PATH}"
          curl -s --header "PRIVATE-TOKEN: ${CI_PUSH_TOKEN}" \
            -X POST "https://${CI_SERVER_HOST}/api/v4/projects" \
            -d "name=${LANG}" \
            -d "namespace_id=${SERVICE_GROUP_ID}" \
            -d "visibility=private" \
            -d "description=Generated ${LANG} gRPC code for ${SERVICE_NAME}" \
            -d "initialize_with_readme=false" | jq -r '.id'
          sleep 2
        else
          echo "Repository exists (ID: ${REPO_ID})"
        fi

        # Clone or init repo
        local WORK_DIR="/tmp/gen-${LANG}"
        rm -rf "${WORK_DIR}"
        mkdir -p "${WORK_DIR}"
        cd "${WORK_DIR}"

        if git clone --depth 1 "${REPO_URL}" . 2>/dev/null; then
          echo "Cloned existing repo"
        else
          echo "Initializing new repo"
          git init
          git remote add origin "${REPO_URL}"
        fi

        # Copy generated code to root
        rm -rf ./*
        cp -r "${LANG_DIR}"/* ./

        # Generate package file
        generate_package_file "${LANG}" "${REPO_PATH}"

        # Create README
        cat > README.md << READMEEOF
      # ${SERVICE_NAME} - ${LANG}

      Generated gRPC/protobuf code for ${SERVICE_NAME}.

      | Info | Value |
      |------|-------|
      | **Version** | ${VERSION} |
      | **Generated** | $(date -u +'%Y-%m-%d %H:%M:%S UTC') |
      | **Source** | [proto/${SERVICE_NAME}](https://${CI_SERVER_HOST}/gitops-poc-dzha/api/proto/${SERVICE_NAME}) |
      | **Commit** | ${CI_COMMIT_SHORT_SHA} |

      ## Documentation

      See [Proto/gRPC Infrastructure Guide](https://${CI_SERVER_HOST}/gitops-poc-dzha/gitops/-/blob/main/docs/proto-grpc-infrastructure.md)
      READMEEOF

        # Commit and push
        git add -A
        if git diff --cached --quiet; then
          echo "No changes to commit for ${LANG}"
        else
          git commit -m "chore: generate ${VERSION} from ${CI_COMMIT_SHORT_SHA}

      Source: ${CI_PROJECT_URL}/-/commit/${CI_COMMIT_SHA}
      Pipeline: ${CI_PIPELINE_URL}
      [skip ci]"
          git push -u origin HEAD:main || git push --force origin HEAD:main

          if [ "${IS_RELEASE}" = "true" ]; then
            git tag -a "${VERSION}" -m "Release ${VERSION}"
            git push origin "${VERSION}"
            echo "Created tag ${VERSION} for ${LANG}"
          fi
        fi

        echo "Published ${LANG} to ${REPO_PATH}"
      }

      # ==========================================
      # Publish all languages
      # ==========================================
      for lang in go nodejs php python angular; do
        publish_lang_repo "${lang}"
      done

      echo ""
      echo "=========================================="
      echo "All languages published for ${SERVICE_NAME} ${VERSION}"
      echo "=========================================="

  rules:
    - if: $CI_COMMIT_BRANCH == "dev"
    - if: $CI_COMMIT_BRANCH == $DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG
