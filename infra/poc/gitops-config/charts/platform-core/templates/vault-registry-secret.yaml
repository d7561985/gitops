{{- if .Values.registry.enabled }}
{{- /*
VaultStaticSecret for registry credentials in each environment namespace.
Creates kubernetes.io/dockerconfigjson secret from Vault for imagePullSecrets.

Source: Vault path defined in registry.vaultPath
Target: Secret named registry.secretName in each environment namespace
*/ -}}
{{- range $envName, $env := .Values.environments }}
{{- if $env.enabled }}
---
apiVersion: secrets.hashicorp.com/v1beta1
kind: VaultStaticSecret
metadata:
  name: {{ $.Values.registry.secretName }}
  namespace: {{ $.Values.global.namespacePrefix }}-{{ $envName }}
  labels:
    app.kubernetes.io/name: platform-bootstrap
    app.kubernetes.io/component: registry-credentials
    environment: {{ $envName }}
  annotations:
    argocd.argoproj.io/sync-wave: "-1"
spec:
  type: kv-v2
  mount: {{ $.Values.vault.mount }}
  path: {{ $.Values.registry.vaultPath }}
  vaultAuthRef: vault-auth
  refreshAfter: 1h
  destination:
    name: {{ $.Values.registry.secretName }}
    create: true
    overwrite: true
    type: kubernetes.io/dockerconfigjson
{{- end }}
{{- end }}
{{- end }}
