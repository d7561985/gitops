{{- /*
Preview Environments - Vault Secrets

Syncs GitLab access token from Vault to argocd namespace.
Required for ArgoCD Pull Request Generator to access GitLab API.

Vault path: secret/data/{previewEnvironments.vault.path}
K8s Secret: {previewEnvironments.gitlab.tokenRef.secretName}

Creates:
1. VaultAuth - allows argocd namespace to authenticate to Vault
2. VaultStaticSecret - syncs the token to K8s secret
*/ -}}

{{- if .Values.previewEnvironments.enabled }}
{{- if .Values.previewEnvironments.vault.enabled }}
---
# VaultAuth for argocd namespace
apiVersion: secrets.hashicorp.com/v1beta1
kind: VaultAuth
metadata:
  name: vault-auth
  namespace: argocd
  labels:
    app.kubernetes.io/name: platform-bootstrap
    app.kubernetes.io/component: preview-environments
spec:
  method: kubernetes
  mount: kubernetes
  kubernetes:
    role: argocd-preview
    serviceAccount: default
    audiences:
      {{- toYaml .Values.vaultAuth.audiences | nindent 6 }}
---
# VaultStaticSecret for GitLab token
apiVersion: secrets.hashicorp.com/v1beta1
kind: VaultStaticSecret
metadata:
  name: {{ .Values.previewEnvironments.gitlab.tokenRef.secretName }}
  namespace: argocd
  labels:
    app.kubernetes.io/name: platform-bootstrap
    app.kubernetes.io/component: preview-environments
spec:
  type: kv-v2
  mount: {{ .Values.vault.mount }}
  path: {{ .Values.previewEnvironments.vault.path }}
  destination:
    name: {{ .Values.previewEnvironments.gitlab.tokenRef.secretName }}
    create: true
  refreshAfter: 1h
  vaultAuthRef: vault-auth
{{- end }}
{{- end }}
