# Bootstrap Application - "App of Apps" pattern
# =============================================================================
# This is the ONLY file you need to apply manually after infrastructure setup.
# It automatically pulls in project.yaml and all platform modules.
# =============================================================================
#
# Architecture:
#   Layer 0: Talos cluster - setup-talos.sh
#   Layer 1-3: Infrastructure - setup-infrastructure.sh (NOT managed by ArgoCD)
#   Layer 4: Applications - ArgoCD (this file triggers everything)
#
# Prerequisites:
#   1. ./shared/scripts/setup-talos.sh           # Create Talos cluster
#   2. export KUBECONFIG=~/.kube/talos-local.yaml
#   3. ./shared/scripts/setup-infrastructure.sh  # Install infrastructure
#
# Bootstrap (one command):
#   kubectl apply -f infra/poc/gitops-config/argocd/bootstrap-app.yaml
#
# This automatically applies:
#   - project.yaml: ArgoCD Project with allowed destinations
#   - platform-modules.yaml:
#     - platform-core: namespaces, gateways, applicationset, vault
#     - service-groups: infrastructure access (ArgoCD, Grafana, Vault)
#     - preview-environments: MR-based previews
#     - ingress-cloudflare: tunnel routing

apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: gitops-bootstrap
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default

  source:
    repoURL: https://gitlab.com/gitops-poc-dzha/infra/poc/gitops-config.git
    targetRevision: main
    path: argocd
    directory:
      recurse: false
      include: '{project.yaml,platform-modules.yaml}'

  destination:
    server: https://kubernetes.default.svc
    namespace: argocd

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=false
      - ApplyOutOfSyncOnly=true
