# Common Talos patches applied to all platforms
#
# These settings are applied on top of the base configuration.
# Use with talosctl cluster create or talosctl gen config.

# Machine-level settings
machine:
  # Secure kernel parameters
  sysctls:
    # Enable IP forwarding (required for CNI)
    net.ipv4.ip_forward: "1"
    net.ipv6.conf.all.forwarding: "1"
    # Increase connection tracking limits
    net.netfilter.nf_conntrack_max: "131072"
    # TCP tuning
    net.core.somaxconn: "32768"
    net.ipv4.tcp_max_syn_backlog: "32768"

  # Time synchronization
  time:
    servers:
      - time.cloudflare.com
      - time.google.com

  # Kubelet configuration
  kubelet:
    extraArgs:
      # Rotate server certificates automatically
      rotate-server-certificates: "true"
    # Resource reservation for system
    nodeIP:
      validSubnets:
        - 10.0.0.0/8
        - 172.16.0.0/12
        - 192.168.0.0/16

# Cluster-level settings (only applies to control plane)
cluster:
  # Allow scheduling on control plane nodes (for single-node dev)
  allowSchedulingOnControlPlanes: true

  # API server extra args
  apiServer:
    extraArgs:
      # Enable aggregation layer
      enable-aggregator-routing: "true"

  # Controller manager extra args
  controllerManager:
    extraArgs:
      # Bind to all interfaces
      bind-address: "0.0.0.0"

  # Scheduler extra args
  scheduler:
    extraArgs:
      bind-address: "0.0.0.0"
