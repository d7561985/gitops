# Cilium Helm values for GitOps POC
# https://docs.cilium.io/en/stable/helm-reference/

# IPAM mode - let Kubernetes manage IPs
ipam:
  mode: kubernetes

# Replace kube-proxy entirely
kubeProxyReplacement: true

# Enable Gateway API support
gatewayAPI:
  enabled: true

# Enable L7 proxy (required for Gateway API)
l7Proxy: true

# =============================================================================
# Hubble - eBPF-based Observability
# =============================================================================
# Hubble provides deep visibility into network flows, DNS, HTTP, and more
# using eBPF. This COMPLEMENTS (not replaces) application-level metrics.
#
# Hubble gives you:
# - L3/L4 network flows (who talks to who)
# - L7 visibility (HTTP, gRPC, DNS requests)
# - Network policy enforcement visibility
# - Service dependency maps
#
# Application metrics (via Prometheus) give you:
# - Request latency, error rates, throughput
# - Business metrics (orders, users, etc.)
# - Resource usage (CPU, memory)
# - Custom application metrics
#
# Both work together for complete observability!
# =============================================================================
hubble:
  enabled: true
  relay:
    enabled: true
  ui:
    enabled: true

  # Prometheus metrics from Hubble
  # Exposes network-level metrics that complement app metrics
  #
  # IMPORTANT: Use labelsContext to see source/destination workload names!
  # Without labelsContext, you only see Cilium Agent metrics, not your services.
  #
  # Available context labels:
  # - source_namespace, source_pod, source_workload, source_app
  # - destination_namespace, destination_pod, destination_workload, destination_app
  # - traffic_direction (ingress/egress)
  metrics:
    enabled:
      - dns:query;ignoreAAAA;labelsContext=source_namespace,source_workload,destination_namespace,destination_workload
      - drop:labelsContext=source_namespace,source_workload,destination_namespace,destination_workload
      - tcp:labelsContext=source_namespace,source_workload,destination_namespace,destination_workload
      - flow:labelsContext=source_namespace,source_workload,destination_namespace,destination_workload
      - icmp
      - port-distribution:labelsContext=source_namespace,destination_namespace
      # httpV2 provides better labels than http (includes status code)
      - httpV2:labelsContext=source_namespace,source_workload,destination_namespace,destination_workload,traffic_direction

    # ServiceMonitor disabled - CRDs not available at Cilium install time
    # Prometheus metrics will be scraped via kube-prometheus-stack additionalScrapeConfigs
    # or enable ServiceMonitors manually after monitoring stack is installed
    serviceMonitor:
      enabled: false

    # Grafana dashboards as ConfigMaps
    dashboards:
      enabled: true
      namespace: monitoring
      annotations:
        grafana_folder: "Cilium"

# =============================================================================
# Prometheus Metrics for Cilium Agent
# =============================================================================
prometheus:
  enabled: true

  # ServiceMonitor disabled - CRDs not available at Cilium install time
  # To enable after monitoring stack is installed, run:
  #   helm upgrade cilium cilium/cilium -n kube-system -f helm-values.yaml \
  #     --set prometheus.serviceMonitor.enabled=true \
  #     --set hubble.metrics.serviceMonitor.enabled=true \
  #     --set operator.prometheus.serviceMonitor.enabled=true
  serviceMonitor:
    enabled: false
    labels:
      release: kube-prometheus-stack
    interval: 30s

# Cilium Agent Grafana dashboards
dashboards:
  enabled: true
  namespace: monitoring
  annotations:
    grafana_folder: "Cilium"

# =============================================================================
# Operator Prometheus Metrics
# =============================================================================
operator:
  replicas: 1
  prometheus:
    enabled: true
    serviceMonitor:
      enabled: false
      labels:
        release: kube-prometheus-stack
  # Operator Grafana dashboards
  dashboards:
    enabled: true
    namespace: monitoring
    annotations:
      grafana_folder: "Cilium"

# For minikube/local development - use NodePort for LoadBalancer services
# In production, you'd use cloud provider's LB or MetalLB
loadBalancer:
  mode: snat

# Enable debug for troubleshooting (disable in production)
debug:
  enabled: false
