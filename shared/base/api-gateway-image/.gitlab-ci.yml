# =============================================================================
# API Gateway Golden Image - Build Pipeline
# =============================================================================
# Build-only pipeline for the base image. No deployment - just image creation.
#
# Versioning:
#   - Commit to main → build with SHA tag (for testing)
#   - Tag v*.*.* → build with version tag (for production use)
#
# Usage by api-gw repo:
#   FROM registry.gitlab.com/gitops-poc-dzha/services/api-gateway-image:v1.0.0
# =============================================================================

variables:
  IMAGE_NAME: ${CI_REGISTRY_IMAGE}

stages:
  - build

build:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        # Release build: v1.0.0
        IMAGE_TAG="${CI_COMMIT_TAG}"
        echo "Building release image: ${IMAGE_NAME}:${IMAGE_TAG}"
        docker build -t ${IMAGE_NAME}:${IMAGE_TAG} .
        docker push ${IMAGE_NAME}:${IMAGE_TAG}

        # Also tag as latest for convenience
        docker tag ${IMAGE_NAME}:${IMAGE_TAG} ${IMAGE_NAME}:latest
        docker push ${IMAGE_NAME}:latest
      else
        # Dev build: commit SHA
        IMAGE_TAG="${CI_COMMIT_SHORT_SHA}"
        echo "Building dev image: ${IMAGE_NAME}:${IMAGE_TAG}"
        docker build -t ${IMAGE_NAME}:${IMAGE_TAG} .
        docker push ${IMAGE_NAME}:${IMAGE_TAG}
      fi
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
