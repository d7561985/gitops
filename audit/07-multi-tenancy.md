# Multi-Tenancy Architecture

## Обзор

Платформа поддерживает multi-tenancy на двух уровнях:
1. **Environments** — dev/staging/prod на одном кластере
2. **Brands/Products** — несколько независимых продуктов на одном кластере

---

## Архитектура Multi-Tenancy

### Один кластер — множество tenant'ов

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        KUBERNETES CLUSTER                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  TENANT A (poc)                          TENANT B (casino)                  │
│  ─────────────                           ────────────────                   │
│  ┌──────────────────────────────┐       ┌──────────────────────────────┐   │
│  │ poc-dev    poc-staging  poc-prod│     │ casino-dev  casino-staging   │   │
│  │ ┌──────┐   ┌──────┐   ┌──────┐│       │ ┌──────┐   ┌──────┐         │   │
│  │ │ apps │   │ apps │   │ apps ││       │ │ apps │   │ apps │         │   │
│  │ └──────┘   └──────┘   └──────┘│       │ └──────┘   └──────┘         │   │
│  └──────────────────────────────┘       └──────────────────────────────┘   │
│         │           │           │               │           │              │
│         ▼           ▼           ▼               ▼           ▼              │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐  ┌──────────┐ ┌──────────┐        │
│  │infra-dev │ │infra-stg │ │infra-prod│  │infra-dev │ │infra-stg │        │
│  │(MongoDB, │ │(MongoDB, │ │(MongoDB, │  │(shared)  │ │(shared)  │        │
│  │ RabbitMQ)│ │ RabbitMQ)│ │ RabbitMQ)│  │          │ │          │        │
│  └──────────┘ └──────────┘ └──────────┘  └──────────┘ └──────────┘        │
│                                                                              │
│  SHARED PLATFORM LAYER                                                       │
│  ────────────────────                                                        │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │  argocd     vault       monitoring    cert-manager    external-dns     │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Изоляция tenant'ов

| Уровень | Механизм | Описание |
|---------|----------|----------|
| **Namespace** | `{prefix}-{env}` | Полная изоляция workloads |
| **Secrets** | Vault paths | `{prefix}/{service}/{env}/config` |
| **Network** | Cilium policies | Namespace-level isolation |
| **Routing** | Gateway per env | Отдельный hostname per environment |
| **RBAC** | K8s + ArgoCD | Доступ только к своим namespaces |

---

## Vault Multi-Tenant Secrets

### Архитектура изоляции секретов

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     VAULT MULTI-TENANT ARCHITECTURE                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  VAULT KV v2 Engine                                                          │
│  ─────────────────                                                           │
│  secret/data/                                                                │
│  ├── gitops-poc-dzha/              ← Tenant A (namespacePrefix: poc)        │
│  │   ├── api-gateway/                                                        │
│  │   │   ├── dev/config            ← poc-dev namespace                      │
│  │   │   ├── staging/config        ← poc-staging namespace                  │
│  │   │   └── prod/config           ← poc-prod namespace                     │
│  │   ├── user-service/                                                       │
│  │   │   ├── dev/config                                                      │
│  │   │   └── prod/config                                                     │
│  │   └── ...                                                                 │
│  │                                                                           │
│  └── casino-brand/                 ← Tenant B (namespacePrefix: casino)     │
│      ├── frontend/                                                           │
│      │   ├── dev/config            ← casino-dev namespace                   │
│      │   └── prod/config           ← casino-prod namespace                  │
│      └── ...                                                                 │
│                                                                              │
│  POLICIES (auto-generated by platform-core)                             │
│  ────────────────────────────────────────────                                │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │ Policy: poc-dev-read                                                   │  │
│  │ path "secret/data/gitops-poc-dzha/*/dev/*" { capabilities = ["read"] } │  │
│  │                                                                        │  │
│  │ Policy: casino-prod-read                                               │  │
│  │ path "secret/data/casino-brand/*/prod/*" { capabilities = ["read"] }   │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  KUBERNETES AUTH ROLES                                                       │
│  ────────────────────                                                        │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │ Role: api-gateway-dev                                                  │  │
│  │   bound_service_account_names: ["default"]                            │  │
│  │   bound_service_account_namespaces: ["poc-dev"]                       │  │
│  │   token_policies: ["poc-dev-read"]                                    │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Автоматическое создание ресурсов

При добавлении сервиса в `values.yaml`, bootstrap job создаёт:

```yaml
# platform-core/templates/bootstrap-job.yaml
# Выполняется при каждом sync

# 1. Policy для namespace/env
vault policy write ${NAMESPACE_PREFIX}-${ENV}-read - <<EOF
path "secret/data/${VAULT_PATH_PREFIX}/*/${ENV}/*" {
  capabilities = ["read"]
}
EOF

# 2. Role для service/env
vault write auth/kubernetes/role/${SERVICE}-${ENV} \
  bound_service_account_names=default \
  bound_service_account_namespaces=${NAMESPACE_PREFIX}-${ENV} \
  token_policies=${NAMESPACE_PREFIX}-${ENV}-read \
  ttl=1h

# 3. Placeholder secret
vault kv put secret/${VAULT_PATH_PREFIX}/${SERVICE}/${ENV}/config \
  placeholder="true"
```

**Источник:** [`gitops-config/charts/platform-core/templates/bootstrap-job.yaml`](../gitops-config/charts/platform-core/templates/bootstrap-job.yaml)

### VSO per Namespace

VaultAuth ресурс создаётся в каждом namespace:

```yaml
# Генерируется platform-core/templates/vault-auth.yaml
apiVersion: secrets.hashicorp.com/v1beta1
kind: VaultAuth
metadata:
  name: vault-auth
  namespace: poc-dev        # ← per namespace
spec:
  method: kubernetes
  mount: kubernetes
  kubernetes:
    role: poc-dev-default   # ← matches Vault role
    serviceAccount: default
    audiences:
      - vault
```

**Источник:** [`gitops-config/charts/platform-core/templates/vault-auth.yaml`](../gitops-config/charts/platform-core/templates/vault-auth.yaml)

### Безопасность

| Принцип | Реализация |
|---------|------------|
| **Least privilege** | Policies только на чтение конкретных путей |
| **Namespace binding** | ServiceAccount привязан к namespace |
| **No cross-tenant access** | Policies изолированы по prefix |
| **Audit** | Vault audit log для всех операций |

---

## Namespace Strategy

### Naming Conventions

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        NAMESPACE NAMING                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  APPLICATION NAMESPACES                                                      │
│  ──────────────────────                                                      │
│  Pattern: {namespacePrefix}-{environment}                                    │
│                                                                              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │
│  │    poc-dev      │  │  poc-staging    │  │    poc-prod     │             │
│  │                 │  │                 │  │                 │             │
│  │ All services:   │  │ All services:   │  │ All services:   │             │
│  │ - api-gateway   │  │ - api-gateway   │  │ - api-gateway   │             │
│  │ - user-service  │  │ - user-service  │  │ - user-service  │             │
│  │ - frontend      │  │ - frontend      │  │ - frontend      │             │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘             │
│                                                                              │
│  INFRASTRUCTURE NAMESPACES                                                   │
│  ─────────────────────────                                                   │
│  Pattern: infra-{environment}                                                │
│                                                                              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │
│  │   infra-dev     │  │ infra-staging   │  │   infra-prod    │             │
│  │                 │  │                 │  │                 │             │
│  │ - MongoDB       │  │ - MongoDB       │  │ - MongoDB       │             │
│  │ - RabbitMQ      │  │ - RabbitMQ      │  │ - RabbitMQ      │             │
│  │ - Redis         │  │ - Redis         │  │ - Redis         │             │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘             │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Service Discovery

| Тип | DNS Format | Пример |
|-----|------------|--------|
| Same namespace | `{service}` | `user-service-sv` |
| Cross namespace | `{service}.{namespace}.svc` | `mongodb.infra-dev.svc` |

```yaml
# default.yaml — environment-agnostic (short DNS)
configmap:
  USER_SERVICE_URL: "http://user-service-sv:8081"

# dev.yaml — environment-specific (FQDN для infra)
configmap:
  MONGODB_URL: "mongodb://mongodb.infra-dev.svc:27017/db"
```

**Источник:** [`docs/multi-tenancy-guide.md:219-260`](../docs/multi-tenancy-guide.md)

---

## Добавление нового Environment

### Шаг 1: Включить в values.yaml

```yaml
# gitops-config/platform/core.yaml

environments:
  dev:
    enabled: true
    autoSync: true
    domain: "app.demo-poc-01.work"
    infraNamespace: "infra-dev"
  staging:                              # ← NEW
    enabled: true
    autoSync: true
    domain: "app.staging.example.com"   # Unique domain!
    infraNamespace: "infra-staging"
```

### Шаг 2: Что создаётся автоматически

При sync platform-modules:

| Ресурс | Имя | Namespace |
|--------|-----|-----------|
| Namespace | `poc-staging` | - |
| Gateway | `gateway` | `poc-staging` |
| VaultAuth | `vault-auth` | `poc-staging` |
| Vault Policy | `poc-staging-read` | Vault |
| Vault Roles | `{service}-staging` | Vault |
| ArgoCD Apps | `{service}-staging` | `argocd` |
| DNS Record | `app.staging.example.com` | CloudFlare |

### Шаг 3: Создать overlay для сервисов

```bash
# Для каждого сервиса
cp services/my-service/.cicd/dev.yaml services/my-service/.cicd/staging.yaml
```

```yaml
# staging.yaml
image:
  tag: "latest"
replicas: 2

configmap:
  MONGODB_URL: "mongodb://mongodb.infra-staging.svc:27017/db"

vault:
  role: my-service-staging
  path: gitops-poc-dzha/my-service/staging/config

httpRoute:
  parentRefs:
    - name: gateway
      namespace: poc-staging
  hostnames:
    - app.staging.example.com
```

**Источник:** [`docs/multi-tenancy-guide.md:383-506`](../docs/multi-tenancy-guide.md)

---

## Добавление нового Brand/Product

### Option A: Отдельный GitOps репозиторий (рекомендуется)

Для полной изоляции:

```
gitops-brand-b/
├── gitops-config/
│   └── charts/
│       └── platform-core/
│           └── values.yaml        # namespacePrefix: brand-b
├── services/
│   └── ...
└── infrastructure/
```

```yaml
# brand-b values.yaml
global:
  gitlabGroup: brand-b-group
  vaultPathPrefix: brand-b
  namespacePrefix: brand-b        # ← Different prefix

environments:
  dev:
    enabled: true
    domain: "app.brand-b.dev"     # ← Unique domain
```

Результат: namespaces `brand-b-dev`, `brand-b-staging`, `brand-b-prod`

### Option B: Тот же репозиторий, другой prefix

```yaml
# gitops-config/charts/brand-b-bootstrap/values.yaml
global:
  vaultPathPrefix: brand-b
  namespacePrefix: brand-b

services:
  brand-b-frontend:
    repoURL: https://gitlab.com/group/brand-b.git
    path: frontend/.cicd
```

**Источник:** [`docs/multi-tenancy-guide.md:522-631`](../docs/multi-tenancy-guide.md)

---

## Изоляция ресурсов

### Resource Quotas

Предотвращение "noisy neighbor":

```yaml
apiVersion: v1
kind: ResourceQuota
metadata:
  name: tenant-quota
  namespace: brand-b-dev
spec:
  hard:
    requests.cpu: "4"
    requests.memory: 8Gi
    limits.cpu: "8"
    limits.memory: 16Gi
    pods: "20"
```

### Network Policies (Cilium)

```yaml
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: namespace-isolation
  namespace: poc-dev
spec:
  endpointSelector: {}
  ingress:
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: poc-dev
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: infra-dev
```

---

## Checklist Multi-Tenancy

### Для нового Environment

- [ ] Добавить в `environments:` с уникальным `domain`
- [ ] Создать `infra-{env}` namespace с MongoDB, RabbitMQ
- [ ] Создать registry secret в новом namespace
- [ ] Создать `{env}.yaml` для каждого сервиса
- [ ] Добавить секреты в Vault
- [ ] Sync platform-modules

### Для нового Brand/Product

- [ ] Выбрать уникальный `namespacePrefix`
- [ ] Настроить уникальные Vault paths
- [ ] Настроить уникальные domains
- [ ] (Опционально) Отдельный ArgoCD Project для RBAC
- [ ] (Опционально) Resource Quotas
- [ ] (Рекомендуется) Отдельный GitOps репозиторий

---

## Преимущества архитектуры

| Аспект | Преимущество |
|--------|--------------|
| **Стоимость** | Один кластер для всех environments и brands |
| **Изоляция** | Namespace + Vault policies + Network policies |
| **Автоматизация** | modular platform charts создают всё необходимое |
| **Self-service** | Команды добавляют environments через PR |
| **Масштабируемость** | Добавление tenant'а не требует участия Platform Team |

---

## Связанные документы

- [Platform Architecture](./01-platform-architecture.md) — Vault + VSO детали
- [GitOps Principles](./02-gitops-principles.md) — Configuration separation
- [Developer Experience](./03-developer-experience.md) — .cicd/ overlays

**Полная документация:** [`docs/multi-tenancy-guide.md`](../docs/multi-tenancy-guide.md)

---

*Документ создан на основе аудита кодовой базы GitOps POC*
*Дата: 2025-12-21*
