# Proto/gRPC CI/CD Components

Reusable GitLab CI/CD components for proto code generation and publishing.

## Zero-Config Usage

**Only 2 things needed in your proto service repo:**

```
your-service/
├── proto/
│   └── your/v1/service.proto   # Your proto files
└── .gitlab-ci.yml              # 3 lines below
```

**.gitlab-ci.yml:**
```yaml
include:
  - project: 'gitops-poc-dzha/api/ci'
    file: '/templates/proto-gen/template.yml'
```

**That's it!** No `buf.yaml` or `buf.gen.yaml` needed. Everything is auto-generated from `CI_PROJECT_NAME`.

## How It Works

1. CI reads your project name (e.g., `user-service`)
2. Generates `buf.yaml` and `buf.gen.yaml` on-the-fly with standard rules
3. Runs lint, breaking change detection, and code generation
4. Publishes to `api/gen/{service-name}/{language}/`

## Generated Languages

| Language | Package Format | Usage |
|----------|----------------|-------|
| Go | `gitlab.com/gitops-poc-dzha/api/gen/{service}/go` | `go get gitlab.com/...` |
| Node.js | `@gitops-poc-dzha/{service}` | `npm install @gitops-poc-dzha/user-service` |
| Python | `gitops-poc-dzha-{service}` | `pip install gitops-poc-dzha-user-service` |
| PHP | `gitops-poc-dzha/{service}` | `composer require gitops-poc-dzha/user-service` (namespace from proto package) |
| Web | `@gitops-poc-dzha/{service}-web` | [Connect-ES](https://connectrpc.com/) gRPC-Web for browsers |

### PHP - Namespace from Proto Package

PHP autoload namespace is **automatically detected** from generated files, matching the proto package declaration:

| Proto package | PHP namespace | Autoload |
|---------------|---------------|----------|
| `wager.v1` | `Wager\V1` | `"Wager\\": "Wager/"` |
| `game.v1` | `Game\V1` | `"Game\\": "Game/"` |
| `payment.v1` | `Payment\V1` | `"Payment\\": "Payment/"` |
| `user.v1` | `User\V1` | `"User\\": "User/"` |

**Usage in Symfony/Laravel:**
```php
use Wager\V1\GetProgressRequest;
use Wager\V1\GetProgressResponse;

$request = new GetProgressRequest();
$request->setUserId('user-123');
```

**composer.json in your service:**
```json
{
  "repositories": [
    {
      "type": "git",
      "url": "https://gitlab.com/gitops-poc-dzha/api/gen/wager-service/php.git"
    }
  ],
  "require": {
    "gitops-poc-dzha/wager-service": "dev-main"
  },
  "config": {
    "gitlab-protocol": "https"
  }
}
```

> **Important:** Use `"type": "git"` (not `"vcs"`) to prevent Composer from auto-switching to SSH for private GitLab repos.

### Web (Connect-ES v2) - Browser gRPC-Web Client

We use **Connect-ES v2** instead of deprecated `grpc-web` + `google-protobuf`:

| Feature | grpc-web (old) | Connect-ES v2 (current) |
|---------|----------------|-------------------------|
| Bundle size | Large | **80% smaller** |
| API style | Java-like (setters/getters) | Idiomatic TypeScript |
| Types | `@types/google-protobuf` (stale) | Built-in |
| DevTools | Binary (unreadable) | JSON (human-readable) |
| Code generation | Two plugins | Single `protoc-gen-es` |
| Maintenance | Minimal support | Active development |

> **Note:** In Connect-ES v2, `protoc-gen-connect-es` was removed. Everything is generated by `protoc-gen-es` into `*_pb.ts` files.

**Usage in Angular/React:**
```typescript
import { createClient } from '@connectrpc/connect';
import { createGrpcWebTransport } from '@connectrpc/connect-web';
// In v2, service is exported from *_pb.ts (not *_connect.ts)
import { UserService } from '@gitops-poc-dzha/user-service-web/user/v1/user_pb';

const client = createClient(UserService, createGrpcWebTransport({ baseUrl: '/api' }));
const response = await client.login({ email, password }); // No setters!
```

**Dependencies (December 2025):**
```json
{
  "@bufbuild/protobuf": "^2.10.0",
  "@connectrpc/connect": "^2.1.0",
  "@connectrpc/connect-web": "^2.1.0",
  "@gitops-poc-dzha/user-service-web": "git+https://gitlab.com/gitops-poc-dzha/api/gen/user-service/web.git#main"
}
```

### Cloudflare Tunnel: Missing Trailer Fix

If you're using **Cloudflare Tunnel** to expose your API, gRPC-Web responses will fail with `[unknown] missing trailer`. This happens because Cloudflare strips the trailer frame from gRPC-Web responses.

**Solution:** Create a custom fetch wrapper that appends a fake trailer to responses missing one:

```typescript
// In your Angular/React service
const transport = createGrpcWebTransport({
  baseUrl: '/api',
  fetch: grpcWebFetchWithTrailerFix,  // Custom fetch wrapper
});
```

The wrapper:
1. Intercepts gRPC-Web responses (`content-type: application/grpc-web`)
2. Checks if trailer frame (flag `0x80`) exists in response body
3. If missing, appends `grpc-status:0\r\n` trailer frame
4. Returns modified response to the library

See `sentry-demo/frontend/src/app/services/auth.service.ts` for full implementation.

## Customization (Optional)

Override defaults via variables in your `.gitlab-ci.yml`:

```yaml
include:
  - project: 'gitops-poc-dzha/api/ci'
    file: '/templates/proto-gen/template.yml'

variables:
  # Generate only specific languages (default: go,nodejs,php,python,web)
  PROTO_GEN_LANGUAGES: "go,web"

  # Use different Buf version
  BUF_VERSION: "1.48.0"

  # Custom default branch
  DEFAULT_BRANCH: "master"
```

## Pipeline Stages

```
┌─────────┐    ┌──────────┐    ┌──────────┐    ┌─────────┐
│  lint   │───►│ breaking │───►│ generate │───►│ publish │
└─────────┘    └──────────┘    └──────────┘    └─────────┘
     │              │               │               │
     ▼              ▼               ▼               ▼
  buf lint    buf breaking     buf generate    git push
  buf format  (vs main)        → gen/{lang}/   → api/gen/
```

## Required CI/CD Variables

Set this at the `api` group level:

| Variable | Description | Protected | Masked |
|----------|-------------|-----------|--------|
| `CI_PUSH_TOKEN` | Personal Access Token with `api`, `write_repository` | No | Yes |

**Note:** Group IDs are resolved automatically from `GEN_GROUP_PATH`. No manual ID configuration needed!

## Versioning

| Trigger | Version Format | Example |
|---------|----------------|---------|
| Push to dev | `v0.0.0-{sha}` | `v0.0.0-abc1234` |
| Push to main | `v0.0.0-{sha}` | `v0.0.0-def5678` |
| Git tag | `v{X}.{Y}.{Z}` | `v1.2.3` |

## Standard Lint Rules

Auto-generated `buf.yaml` includes:

- **STANDARD** lint rules (minus verbose comment requirements)
- Enum zero value suffix: `_UNSPECIFIED`
- Service suffix: `Service`
- Breaking change detection: `FILE` level

## Migration from Manual buf.yaml

If you have existing `buf.yaml`/`buf.gen.yaml`, you can delete them! The CI will generate compatible configs automatically.

```bash
# In your proto service repo
rm buf.yaml buf.gen.yaml
git add -A
git commit -m "chore: switch to zero-config proto CI"
git push
```
