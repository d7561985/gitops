# CI/CD for the proto-gen component itself
# Tests and releases the component

stages:
  - test
  - release

variables:
  # Component must be in CI/CD Catalog to be used
  COMPONENT_PATH: "proto-gen"

# ============================================
# Test: Validate component syntax
# ============================================
validate-component:
  stage: test
  image: alpine:3.19
  script:
    - apk add --no-cache yq
    - echo "Validating component template syntax..."
    - yq eval '.' templates/${COMPONENT_PATH}/template.yml > /dev/null
    - echo "Checking spec section..."
    - yq eval '.spec.inputs' templates/${COMPONENT_PATH}/template.yml
    - echo "Component validation passed!"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG

# ============================================
# Test: Dry-run include
# ============================================
test-component-include:
  stage: test
  image: alpine:3.19
  script:
    - echo "Testing component can be included..."
    - |
      cat > /tmp/test-pipeline.yml << 'EOF'
      include:
        - local: 'templates/proto-gen/template.yml'
          inputs:
            languages: [go, nodejs]
      EOF
    - echo "Component include test passed!"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

# ============================================
# Release: Create GitLab release
# ============================================
create-release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  script:
    - echo "Creating release ${CI_COMMIT_TAG}..."
  release:
    tag_name: $CI_COMMIT_TAG
    name: "Proto-Gen Component ${CI_COMMIT_TAG}"
    description: |
      ## Proto-Gen CI/CD Component ${CI_COMMIT_TAG}

      ### Usage

      ```yaml
      include:
        - component: ${CI_SERVER_HOST}/${CI_PROJECT_PATH}/proto-gen@${CI_COMMIT_TAG}
          inputs:
            languages: [go, nodejs, python]
      ```

      ### Changes

      See [CHANGELOG](${CI_PROJECT_URL}/-/blob/${CI_COMMIT_TAG}/CHANGELOG.md) for details.
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
